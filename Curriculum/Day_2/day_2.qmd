---
title: "Day 2"
format: html
---
<div style="background: ghostwhite; 
            padding: 10px; 
            border: 2px solid lightgray; 
            margin: 10px;">

<!-- Sam start -->

# Objectives
-   Learn the basics of creating a stock assessment report using {asar}
-   Understand the complexities and customization options of the package
-   Practice using {asar} and ask questions
</div>

# Introduction
## Icebreaker

Welcome! Please open the [Day 2 communal notes doc](https://docs.google.com/document/d/1SY-xwHXnJUXSXTTeaPA_UkmXXVmUK9Ol751nh6Vtjmg/edit?tab=t.ds1fl2nu2oi5#heading=h.piviu2gu74mf) and participate in the icebreaker exercise.

## Code of conduct

Everyone participating in this workshop is required to abide by the terms of our [Code of Conduct](https://github.com/nmfs-ost/asar/blob/main/CODE_OF_CONDUCT.md). We encourage you to contribute to a positive environment for our community by:

-   Demonstrating empathy and kindness toward other people
-   Being respectful of differing opinions, viewpoints, and experiences
-   Giving and gracefully accepting constructive feedback
-   Accepting responsibility and apologizing to those affected by our mistakes, and learning from the experience
-   Focusing on what is best not just for us as individuals, but for the overall community

If you believe that someone is in violation of the Code of Conduct, please report the incident to the workshop instructors and/or the community leaders responsible for enforcement using [this form](https://docs.google.com/forms/d/e/1FAIpQLSftcxC8XuyoXJzrNS8cM8fXvuRWo1hnyS3TtI_VlM-XFmMYGQ/viewform).

## Materials for today's lesson

-   [Day 2 communal notes doc](https://docs.google.com/document/d/1SY-xwHXnJUXSXTTeaPA_UkmXXVmUK9Ol751nh6Vtjmg/edit?usp=sharing)
    -   Contains resources (from us and you!) and areas for note-taking
-   [Sample data](https://github.com/nmfs-ost/asar/blob/main/inst/extdata/Report.sso)
    -   Sample model output data for coding demonstrations

## How to engage with us

**Questions**: Please raise your hand, or write your question in the chat, at any time. Depending on our schedule, we may ask that you save larger questions for breaks.

::: {.callout-note appearance="minimal"}
You probably have some questions lingering from yesterday. Let us answer them for you!
:::

<!-- ::: {.callout-note appearance="minimal"} -->
<!-- Break for questions -->
<!-- ::: -->

# {asar}: Automated Stock Assessment Reporting

In this section we will cover the basics of {asar} by generating a stock assessment report and going through basic navigation of the template.

## Installation

{asar} should already be installed if you attended Day 1. If not, please install this package by following the instructions in the [pre-workshop checklist](https://nmfs-ost.github.io/workflows-workshop/resources/checklist.html).

::: {.callout-note}
If you receive an error message when attempting the download the package, please ask the instructor for alternative directions or see the README on the [{asar} repository](https://github.com/nmfs-ost/asar).
:::

## Overview of {asar}-based reporting workflow

Main steps for creating a stock assessment report with {asar}:

1. Install packages
2. Convert model output into format usable by {asar}
3. Create the report skeleton
4. Make child docs containing figures and tables (made with {stockplotr} or by other means)
5. Fill in child docs with text
6. Render report
7. Add accessibility features (PDF tags and alternative text for figures)

::: {.callout-tip}
Open the [{asar} cheatsheet](https://nmfs-ost.github.io/asar/asar_cheatsheet.pdf) for a visual overview of the main workflow!
:::

## Recommended workflow

We *highly* recommend using a project-based workflow. This involves creating an R project for each report, which facilitates returning to your session and maintaining files. Using either a project or GitHub repository will help you in the long run.

To create a new R project in Rstudio:

File > New Project > New or Existing Directory

::: {.callout-important}
If you use VSCode or Positron for your IDE, by navigating to a folder on your computer, it will automatically initialize a project-like environment.
:::

## The main functions

{asar} revolves around a few primary functions and contains several support functions that help make the template. While most are accessible to the user, they would not perform helpful functions for them. Today, we will focus on the following functions:

- `asar::create_template()`
- `stockplotr::convert_output()` (This function is now located within {stockplotr} but is useful for building {asar} reports)
    
<!-- ** Time to browse documentation? or show info from site? ** -->

### `asar::create_template()`

**What it does:**

Generates a set of files that setup a stock assessment report with its supporting files.

Within the created files is the "skeleton file" which drives the render of the entire report. For those familiar with Rmarkdown or Quarto books, this is operating similar to a .yml file. The other Quarto files found in your folder will be what we refer to as "child documents", or child docs for short. These are the actual files that you will fill in when writing your report. These are the bulk of your content!

**Try it out!**

`create_template()` contains *A LOT* of arguments that allow the user to customize their document how
they want. The function contains a set of defaults that would produce a template that could be rendered,
but contains no real information relevant to the target stock.

So, let's do more than just create a blank template! The following arguments are some key parts to fill in for a specific stock assessment report:

| Argument | Options    |
|----------|------------|
| format   | pdf, html |
| type     | SAR, pfmc, safe, nemt |
| office   | afsc, pifsc, nefsc, nwfsc sefsc, swfsc |
| region   |  - |
| species  |  - |
| spp_latin | - |
| year | - |
| authors | - |
| file_dir | - |


```{r}
#| label: basic-ex
#| eval: false
# Adjust below example based on audience
library(asar)
create_template(
  format = "pdf", # optional "html"
  type = "SAR", # add'l options: "safe", "nemt", "pfmc"
  office = "NWFSC",
  region = "U.S. West Coast",
  species = "Petrale sole",
  spp_latin = "Eopsetta jordani",
  authors = c("Samantha Schiano" = "OST", "Jane Doe"="SWFSC-LJCA"),
  file_dir = getwd() # folder where the "report" folder will be saved
)
```

**Run it!**

You should see a folder called "**report**" where you indicated in the argument `file_dir`. It should have a set up that looks like this:

![The contents of an asar-generated template found in the report folder.](images/asar_files.png){fig-alt="A screenshot of files that should appear in the 'report' folder, including '01_executive_summary.qmd', '02_introduction.qmd', '03_data.qmd', and more."}

::: {.callout-note}
You should see a variety of messages reported in the console to indicate
that it worked! For a blank template with no errors, it should look like this:

![](images/blank_template_output_messages.png){fig-alt="A screenshot of console text expected when `create_template()` is run successfully."}
:::

::: {.callout-note appearance="minimal"}
Break for questions
:::

#### Let's take a tour of the content we created!

##### The skeleton

![Diagram showing different blocks of content found in the Quarto yaml within the skeleton.qmd file.](images/asar_skeleton.png){fig-alt="A figure showing seven rectangles on top of one another, portraying the order of content in a Quarto yaml. Sections include 'Yaml (Formatting and input information)', 'Parameters R chunk', 'Preamble R chunk', 'Disclaimer', 'Citation', 'Report content ('child docs'): Executive Summary', an ellipsis to separate the blocks, and then a final block ('Report content ('Child docs'): Appendix')."}

As previously mentioned, the skeleton file controls the rest of the report. This 
is the file you go to to compile your report, change formatting, or add quantities
to reference in your document.

We went over the basics of a Quarto yaml in [Day 1](https://nmfs-ost.github.io/workflows-workshop/Curriculum/Day_1/day_1.html#yaml), but when using {asar}, you don't actually have to fill in anything yourself. The beauty of using {asar} is that it removes this task, but filling out information provided in the `create_template()` arguments and providing the template custom formatting that is part of the package (and the NOAA standard!).

::: {.callout-note}
You shouldn't have to adjust the yaml much, if at all. However, if your `species` does not match with an image in our [database](https://github.com/nmfs-ost/asar/tree/main/inst/resources/spp_img), then you can edit the yaml to add a filepath leading to your own cover image.
:::

![asar yaml controlling formatting and basic document information.](images/asar_yaml.png){fig-alt="A screenshot of an example yaml, with curly brackets highlighting which code is 'information' and which code is 'formatting'."}

The YAML controls the following:

- title
- authorship
- formatting
- rendered file name
- parameters
- species cover image
- bibliography
- citation style

##### Parameterization

Quarto has a cool feature that allows users to parameterize their document by utilizing markdown's ability to render in-line code throughout your writing. In the yaml, there are pre-added parameters of the species, Latin name, region, and office. These are called in through an R chunk after the YAML.

You have two options for calling these parameters in your writing.

1. \` r params$species \` (Quarto parameterization)
2. \` r species \` ({asar} use of parameterization)


##### The preamble

The preamble is an R chunk that loads in a script called "preamble.R" which extracts key quantities commonly referenced in stock assessment reports. This will only work with a standard results file converted using `asar::convert_output()`, which we will get to shortly.

![A screenshot showing lines of code in an R chunk within the skeleton file containing various quantities pulled from the preamble.R script.](images/preamble.png){fig-alt="A screenshot of the preamble, with the R chunk option 'eval: false' highlighted."}

The quantities in found in this chunk can be referenced in-line throughout the document:

\` r R0 \`

::: {.callout-note}
For more information on markdown notation, see [Day 1](https://nmfs-ost.github.io/workflows-workshop/Curriculum/Day_1/day_1.html) of this workshop or navigate to [our article](https://nmfs-ost.github.io/asar/articles/markdown_notation.html) on the topic!
:::

**Let's find the preamble and see the methods to edit it**

##### The content

The "child docs" are where you as the assessment author or contributor report out the information you need to include. The template is highly modular so there are files for each section of the report and sometimes files for subsections. The default {asar} template creates child docs following the [NOAA standard stock assessment report guidelines](https://github.com/nmfs-ost/workflows-workshop/tree/main/assets/standard_guidelines.pdf) consisting of the following:

- executive summary
- introduction
- data
- assessment (modelling and results)
- discussion
- acknowledgements
- references
- tables
- figures
- appendix

Each child doc contains pre-determined headers and labels for the author to reference back to throughout the document. There are also descriptions within each section that depict what you should report on throughout the document. You can either keep or remove these notes once the document is finished, either way, they will not be included in your final report.

Child docs are not intended to be rendered on their own, but only from the skeleton as a whole!

::: {.callout-important}
We are advising everyone that if any content needed beyond the standard guidelines gets placed in the appendix; however, we encourage everyone to think about the importance of the content in terms of review for management versus CIE or SSC review.
:::

**Demo of child docs and adding quantities from the preamble into your document**

Please add the following text into your "introduction" section:

```{verbatim}
The stock assessment for `r params$species` was conducted by the `r params$office` in `r params$region`. The terminal spawning biomass for the current assessment year (`r end_year`) was `r SBend`. You can find more information on the results of this assessment in @sec-assessment-results. The guidelines for this report follow those outlined in @akaiki_new_1974.
```

::: {.callout-note appearance="minimal"}
20 minute break for questions & practicing
:::

{{< include ../snippets/template_exercises.qmd >}}

### `stockplotr::convert_output()`

**What it does:**

This function, which was **formerly located within {asar} but has been moved to {stockplotr}**, converts an output file from a stock assessment model to a standard format. This file can be used to extract quantities within the preamble and to build figures and tables with {stockplotr} (covered in [Day 3](https://nmfs-ost.github.io/workflows-workshop/Curriculum/Day_3/day_3.html)).

The `convert_output` function currently accepts output from Stock Synthesis (Report.sso) version 3.30 and higher, Beaufort Assessment Model (BAM; output.rda), or Fisheries Integrated Modelling System (FIMS; R object). We are actively working on expanding the `convert_output` function to be compatible with all major U.S. stock assessment models. This function takes a lot of resources to develop, so any contribution to the package is welcome! If you have a model that is not currently compatible with `stockplotr::convert_output()`, please navigate to [our article](https://nmfs-ost.github.io/stockplotr/articles/convert_output_details.html) describing the function and how to get your output in the same format as those produced from the converter!

**Let's try it out!**

We have uploaded an example Report.sso file in the workshop GitHub, but if you have a compatible output file, we encourage you to use your own.

```{r}
#| label: conout-ex
#| eval: false
#| warning: false
#| messages: false
# Identify output file
output_file <- file.path("example_output", "Report.sso")
# convert the output
petrale <- stockplotr::convert_output(
  output_file,
  save_dir = file.path(getwd(), "report", "petrale_conout.rda")
  )

# copy the converted output to your wd too, for later usage
file.copy(
  from = file.path(getwd(), "report", "petrale_conout.rda"),
  to = getwd()
  )
```

**Run it!**

```{r eval=FALSE}
petrale
```

![A screenshot of the first 8 columns and 10 rows of data from a standard output tibble converted from a stock synthesis Report.sso file.](images/petrale_conout.png)

::: {.callout-tip}
`convert_output()` will recognize which model the results file came from as well as fleet names. In the rare case either of these are incorrect, the function contains arguments of `model` and `fleet_names` which you as the user can indicate for the function.

If you are explicitly stating fleet names, make sure they are in the order you expect them to be found in the file.
:::

#### Format of converted output

The converted output is a tibble that reframes and reshapes your data. The tibble contains each output value as a row with its error and any associated indexing values.


::: {.callout-note}
Let's walk through a standard output file in more detail.
:::

{{< include ../snippets/filter-std-output.qmd >}}

::: {.callout-note}
For more information, navigate to [this article](https://nmfs-ost.github.io/stockplotr/articles/convert_output_details.html) describing the conversion process and find ways your can convert your model's data!
:::

::: {.callout-note appearance="minimal"}
20 minute break for questions & practicing
:::

## Advanced {asar} workflow
<!-- Sophie start -->

<!-- A few ways to make your SARs more customized and flexible -->

Now we are going to walk-through a more complex use of {asar} by

- Customizing sections
- Updating reports after initial setup
  - Adding additional parameters
  - Adding model results
  - Adding a new author
  
<!-- - Calling a previous report and editing -->

### Create-your-own

<!-- The main template: "SAR"- standard assessment report -->
<!-- We are working to set standard assessment report guidelines across the country. But in the meantime, there are a few ways you can customize your reports to suit you needs: -->

<!-- 1. three extra template options- one of which is for SAFE reports -->
<!-- 2. you can also add new sections within existing sections (like, within the introduction), or as independent sections -->

<!-- We'll focus on showing you how to edit your sections in a standard assessment report. First, please rename your previous 'report' folder to something like "simple_report" or something similar to distinguish from this more complex 'report' folder. -->

<!-- *Rename "report" to "simple_report"* -->
<!-- *Highlight what args mean- esp. new args* -->

There are *three additional template options* available to users to use while we work to set standard assessment report guidelines across the country:

* SAFE reports (`create_template(type = 'safe')`)
* NEFSC management track reports (`create_template(type = 'nemt')`)
* PFMC guidelines (`create_template(type = 'pfmc')`)

You can also:

* add new sections within the current outline
* add new sections in individual sections
* select sections of the standard template to include in your report

Today, we will be going over how to customize your template by selecting a subset of the standard guidelines, then adding in a new section after our introduction

First, let's make our template. 

**We are creating a new report, so please set your working directory to a new folder or rename our previous "simple" report folder to "simple_report" or something along those lines.**

```{r eval=FALSE}
asar::create_template(
  # Previous arguments we used for simple
  format = "pdf",
  office = "AFSC",
  region = "Gulf of Alaska",
  species = "Rex sole",
  spp_latin = "Glyptocephalus zachirus",
  authors = c("Samantha Schiano" = "OST"),
  # New arguments
  custom = TRUE, # set this to TRUE when you're choosing a subset of standard sections
  custom_sections = c("executive_summary",      
                      "introduction",           
                      "data"), # list of sections from SAR to add
  new_section = "Changes to the Model", # new section name
  section_location = "after-introduction" # location of new section
 )
```

::: {.callout-tip}
To identify what sections you can include from the standard guidelines (i.e., options for `custom_sections`), you can run `list.files(system.file("templates", "skeleton", package = "asar"))`. Note: this only includes sections within a standard template. To see other sections for available templates, replace "skeleton" with your target template acronym.

Don't worry if you forget! You can find this code in the documentation for the `custom_sections` argument.
:::

::: {.callout-note appearance="minimal"}
Break for questions
:::

### Rerendering report

We understand that it's easy to forget to enter in all of the information you need for a report on its initial creation! Because of this, we made the argument "rerender_skeleton" that adds on any new information to the skeleton file that you might want such as additional authors, a new species image, parameters, or anything that is open for you to customize in the skeleton file. 

You COULD do this manually, but using the function both allows you to create a record of your changes (making it more reproducible) *and* makes the Quarto yaml less intimidating to new users!

::: {.callout-note}
You can run re-render skeleton as often as you want, it will always edit the current skeleton in the folder. Please note: any additional skeleton files will make this process fail. The process will also verify that you want to overwrite the current skeleton and either keep or replace the key quantities file.
:::

#### Our changes: new parameters, additional author, and add model results file

Let's add some more parameters to our script which will allow us to references in-text throughout the document.

::: {.callout-important}
The console will return this question:

> Do you want to keep the current preamble? (Y/N)

When you are rerendering your skeleton in a way that edits your preamble (e.g., when you add new model results), your answer should typically be NO (n).

Just be aware that these changes will, in fact, change your current preamble and overwrite any edits you made to that file.
:::


```{r eval=FALSE}
asar::create_template(
  rerender_skeleton = TRUE,
  file_dir = file.path(getwd(), "report"),
  parameters = TRUE,
  param_names = c("fleet_a", "fleet_b"),
  param_values = c("a long fleet name", "b long fleet name")
)
```

Now, I need to:

1. Add my co-authors to my report (I wasn't sure who they were when I created my report template)
2. Add in the converted model results file (Forgot to add this initially!)

```{r eval=FALSE}
asar::create_template(
  rerender_skeleton = TRUE,
  file_dir = file.path(getwd(), "report"),
  model_results = file.path(getwd(), "report", "petrale_conout.rda"),
  authors = c("Ben Williams"="AFSC")
)
```

::: {.callout-warning}
Some chunks may need minor updates, particularly the "output_and_quantities" chunk.
Ensure that the model results file is being loaded properly (i.e., its relative filepath is correct) and `eval` is TRUE or FALSE, depending on your needs.
:::

::: {.callout-tip}
Check out the ["Frequently Asked Questions (FAQs)" vignette](https://nmfs-ost.github.io/asar/articles/faqs.html) to find how to solve common issues encountered when using {asar}.
:::

::: {.callout-note icon=false}
## Testing your understanding

You notice a typo in the "Executive Summary" of your report PDF. Where should you fix it so that the change persists in future versions?

A) The final rendered PDF file
B) The "skeleton" file
C) The specific modular file (01_executive_summary.qmd).
D) Re-run the `create_template()` function with the corrected text as an argument

:::

<!-- Answer: C. -->
<!-- A identifies thinking towards old workflow: manual post-processing -->
<!-- B identifies forgetting the modularity of {asar} -->
<!-- D identifies mistake in understanding purpose of create_teamplate(). create_template() is a tool that builds the structure of your report, but not the detailed content of it (body of text). -->


::: {.callout-note icon=false}
## Testing your understanding

You've used {asar} to set up a stock assessment report. You realize there's some region-specific information you need to add, and it doesn't seem to fit into any of the main sections (e.g., introduction, data, discussion). Which of the following ways can you add it to your report?

A) Add it to the appendix
B) Add the text to the end of the skeleton qmd
C) Add a new section with `create_template()`'s `new_section` argument
D) You can't

:::

<!-- Answer: A and C. -->
<!-- With B, you'd miss out on headers and proper inclusion in the table of contents. -->
<!-- D isn't true. -->

<!-- Add back in once section is developed -->

<!-- ::: {.callout-note appearance="minimal"} -->
<!-- Break for questions -->
<!-- ::: -->

<!-- ### Calling previous report -->

::: {.callout-note appearance="minimal"}
20 minute break for questions & practicing
:::

{{< include ../snippets/complex_asar_exercises.qmd >}}

# Summary (10 mins)

You should now be able to

- Create and fill in a report template
- Understand how to use parameters and key quantities within text
- Understand the format of a standard output object
- Know how to customize a report
<!-- - Know how to pull and update and old report that used {asar} -->

# Final Reminders

<!-- - We will be holding office hours tomorrow 30 minutes before the next session starts for any questions. -->
- Feel free to practice some more tonight and come tomorrow with any questions you may have.

