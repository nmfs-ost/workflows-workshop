---
title: "Day 3"
format: html
execute:
  eval: false
---
<div style="background: ghostwhite; 
            padding: 10px; 
            border: 2px solid lightgray; 
            margin: 10px;">
# Objectives
-   Walk through an example of a plot and table from {stockplotr}
-   Learn about the value of the {stockplotr} R package
-   Understand how to integrate {stockplotr} into an {asar}-based reporting workflow
</div>

# Introduction
## Icebreaker

Welcome! Please open the [Day 3 communal notes doc](https://docs.google.com/document/d/1SY-xwHXnJUXSXTTeaPA_UkmXXVmUK9Ol751nh6Vtjmg/edit?tab=t.vffehz79fm7y#heading=h.sfq3xaeehv64) and participate in the icebreaker exercise.

::: {.callout-tip}
**Reminder**: For comments or questions, please raise your hand, or write them in the chat, *at any time*. Depending on our schedule, we may ask that you save larger questions for breaks.
:::

::: {.callout-note appearance="minimal"}
Break for questions
:::

## Materials for today's lesson

-   [Day 3 communal notes doc](https://docs.google.com/document/d/1SY-xwHXnJUXSXTTeaPA_UkmXXVmUK9Ol751nh6Vtjmg/edit?tab=t.vffehz79fm7y#heading=h.sfq3xaeehv64)
    -   Contains resources (from us and you!) and areas for note-taking
-   [Sample data](https://github.com/nmfs-ost/asar/blob/main/inst/extdata/Report.sso)
    -   Sample model output data for coding demonstrations
-   [Example figure and table](https://github.com/nmfs-ost/workflows-workshop/blob/main/example_plots)
    -   Example figure and table for coding demonstration

## Installation

{asar}, {stockplotr}, and {tinytex} should already be installed if you attended Days 1 or 2. If not, please install these packages by following the instructions in the [pre-workshop checklist](https://nmfs-ost.github.io/workflows-workshop/resources/checklist.html).

# Introduction to {stockplotr}

## Convert output (if necessary)

First, you'll need to convert your model results using the same workflow covered yesterday: `stockplotr::convert_output()`.

You can use the example Report.sso file uploaded to the workshop GitHub or, if you have a compatible output file, your own.

```{r}
#| label: conout-ex
#| eval: false
#| warning: false
#| messages: false
# Identify output file
output_file <- file.path("example_output", "Report.sso")
# convert the output and save it as an rda
petrale <- stockplotr::convert_output(output_file,
                                      save_dir = getwd())
```

If you have already converted your output: great! Import it into your R environment so that you can handle it as an object like "petrale" in the chunk above.

::: {.callout-note appearance="minimal"}
Break for issues
:::

## Package information

This package is an ongoing process to gather contributions in order to expand the number of pre-made tables and figures that can be incorporated into a stock assessment report. All objects are intended to be generalized and not specific to any region.

{stockplotr} also contains `convert_output()`: the function used to convert model results into a standardized output (as explained in a [previous section](https://nmfs-ost.github.io/workflows-workshop/Curriculum/nsaw.html#stockplotrconvert_output)). This standardized output is the input for the {stockplotr} plotting functions, below (the `dat` argument).

The following table contains figures and tables that are available in {stockplotr}:

| Function | Description |
|----------|-------------|
| `plot_abundance_at_age()` | abundance-at-age |
| `plot_biomass_at_age()` | biomass-at-age |
| `plot_biomass()` | biomass time series |
| `plot_catch_comp()` | catch compositions |
| `plot_fishing_mortality` | fishing mortality time series |
| `plot_indices()` | indices |
| `plot_landings()` | landings time series |
| `plot_natural_mortality()` | natural mortality time series or at-age |
| `plot_recruitment_deviations()` | recruitment deviations |
| `plot_recruitment()` | recruitment time series |
| `plot_spawn_recruitment()` | spawn recruitment relationship |
| `plot_spawning_biomass()` | spawning biomass time series |
| `table_landings()` | landings time series by fleet or other indexing |
| `table_bnc()`- *coming soon* | biomass, landings, and catch time series |
| `table_harvest_projection()`- *coming soon* | harvest projection table according to SAFE standards (to be expanded nationally) |
| `tables_indices()`- *coming soon* | indices by fleet |

Each automated function returns either a `ggplot2` object (figure) or `gt` object (table). This allows for further customization of the output if desired by using the notation you are familiar with. For a figure, you can continue to add onto the plot any other `ggplot2` function or extension using the plus (+) operator. For a table, please use the native pipe (|>) when adding additional formatting, rows, or other pieces to the object.

## Example Figure

Run the example below. It should result in a line graph showing biomass over time, including a reference line for the biomass unfished.

```{r eval = FALSE}
stockplotr::plot_spawning_biomass(
  dat = petrale, # dataset
  geom = "line", # show a line graph
  group = NULL, # don't group by sex, fleet, etc.
  facet = NULL, # not faceting by any variable
  ref_line = "msy", # set reference line at unfished
  unit_label = "mt", # unit label: metric tons
  scale_amount = 1, # do not scale biomass
  relative = FALSE, # show biomass, NOT relative biomass
  interactive = TRUE, # prompt user for MODULE_NAME in console
  module = NULL # MODULE_NAME not specified here
)
```

![](images/day3_ex_plt1_a.png)

::: {.callout-note appearance="minimal"}
Break for questions
:::

### Customizing

All figures will automatically identify any indexing variables in the data such as fleet, area, or sex. You can use the `group` and `facet` arguments to modify how these indexing variables are displayed in the figure. You can also modify other arguments such as `geom`, `ref_line`, and `relative` to change the appearance of the figure. 

#### Change the reference line to a specific value (e.g., 260)
  
  In this example we are also telling the function which module to select in order to by-pass this step. We plan to remove grouping of some modules in the future.

```{r}
stockplotr::plot_spawning_biomass(
  dat = petrale,
  geom = "line",
  group = NULL,
  facet = NULL,
  ref_line = c("target" = 10), # changed from "unfished"
  unit_label = "mt",
  scale_amount = 1,
  relative = FALSE,
  interactive = FALSE, # changed from TRUE
  module = "TIME_SERIES" # indicate module name here
)
```

![](images/day3_ex_plt2_b.png)

#### Plot relative spawning biomass and change the size of the line
  
In this example, we still are bypassing module selection and we are automatically extracting the reference line value from the data. However, now we are using this reference value to plot relative spawning biomass and changing the linewidth to 2 (an argument inherited from `ggplot2::geom_line()`).
  
::: {.callout-note}
If you were plotting a scatterplot (`geom = 'point'`) or area plot (`geom = 'area'`), you could add arguments associated with `geom_point()` and `geom_area()`, respectively.
:::

```{r}
stockplotr::plot_spawning_biomass(
  dat = petrale,
  geom = "line",
  group = NULL,
  facet = NULL,
  ref_line = c("target" = 10),
  unit_label = "mt",
  scale_amount = 1,
  relative = TRUE, # changed from FALSE
  interactive = FALSE,
  module = "TIME_SERIES",
  linewidth = 2 # increase width of lines
)
```

![](images/day3_ex_plt3_b.png)

::: {.callout-tip}
The only extended arguments available are the ones found from the ggplot2::geom_XX() function. Thus, any indexed variables can not be changes such as color to fill. Please see the documentation for `ggplot2` geom functions for these additional arguments.
:::

#### Summarize our data
  
Notice that you can remove the reference line by setting `ref_line = NULL`.
  
```{r}
stockplotr::plot_spawning_biomass(
  dat = petrale,
  geom = "line",
  group = "none",
  facet = NULL,
  ref_line = NULL, # changed from c("target" = 260)
  unit_label = "mt",
  scale_amount = 1,
  relative = FALSE,
  interactive = FALSE,
  module = "TIME_SERIES"
)
```

![](images/day3_ex_plt4_b.png)

::: {.callout-note appearance="minimal"}
Break for questions
:::

::: {.callout-tip}
Remember that figures return `ggplot2` objects, so we can make additional customization to these plots.
:::

```{r}
stockplotr::plot_spawning_biomass(
  dat = petrale,
  geom = "line",
  group = "fleet",
  facet = NULL,
  ref_line = c("target" = 10),
  unit_label = "mt",
  scale_amount = 1,
  relative = FALSE,
  interactive = FALSE,
  module = "TIME_SERIES"
) +
  ggplot2::geom_vline(xintercept = 2005, linetype = "dashed", color = "red")
```

![](images/day3_ex_plt5_b.png)

::: {.callout-note appearance="minimal"}
Break for questions. We will be moving onto tables next.
:::

## Example Table

Run the following example table. The result is a fully report ready table showing landings over time. Remember that these are exported as `gt` objects and can be edited as such.

::: {.callout-note}
{stockplotr} uses the native pipe (|>), so if you decide to customize you table, please also use the native pipe to avoid errors.
:::

```{r eval = FALSE}
stockplotr::table_landings(
    dat = petrale,
    unit_label = "mt",
    module = "CATCH"
)
```

![](images/day3_ex_table1.png)

::: {.callout-note appearance="minimal"}
Break for questions
:::

Next, we can add some different formatting:

```{r}
library(gt)
stockplotr::table_landings(
    dat = petrale,
    unit_label = "mt",
    module = "CATCH")[[1]] |> # [[1]] pulls the gt table from the list
  gt::tab_style(
        style = cell_text(weight = "bold"),
        locations = cells_body(columns = "Year")
    ) |>
  gt::tab_style(
        style = cell_text(style = "italic"),
        locations = cells_body(columns = 2:3)
    )
```

![](images/day3_ex_table2.png)

or potentially highlight a specific line within the table:

```{r}
stockplotr::table_landings(
    dat = petrale,
    unit_label = "mt",
    module = "CATCH")[[1]] |>
    gt::tab_style(
        style = cell_text(weight = "bold"),
        locations = cells_body(columns = "Year")
    ) |>
    gt::tab_style(
        style = cell_text(style = "italic"),
        locations = cells_body(columns = 2:3)
    ) |>
    gt::tab_style(
        style = cell_fill(color = "yellow"),
        locations = cells_body(
            rows = 2
        )
    )
```

![](images/day3_ex_table3.png)

::: {.callout-tip}
Check out the [{stockplotr} cheatsheet](https://nmfs-ost.github.io/stockplotr/stockplotr_cheatsheet.pdf) to quickly reference the main concepts of this package!
:::

::: {.callout-note appearance="minimal"}
Break for questions
:::

## Exporting

You can export any table or plot along with their associated caption and alternative text (figures only) in the format of an rda file. An rda is an R data file that stores R objects and preserves their structure. In this case, you can think of an rda file exported from {stockplotr} as a list of objects.

Each plot or table has the option to export it as an rda. This rda is a list of 3 associated components for the plot/table to be used in a stock assessment report:

- `ggplot2` or `gt` object
- caption
- alternative text (figures only)
- LaTeX object (tables only)

```{r}
stockplotr::plot_spawning_biomass(
  dat = petrale,
  ref_line = c("target" = 10),
  unit_label = "mt",
  module = "TIME_SERIES",
  make_rda = TRUE,
  figures_dir = getwd() # indicate where to create a "figures" folder with the biomass figure rda
)
```

Let's explore the rda's components.

```{r}
load("figures/spawning.biomass_figure.rda")
rda$figure
rda$caption
rda$alt_text
```

::: {.callout-note appearance="minimal"}
Break for questions
:::

This is the code you *would* run to export a landings table, but [it is not yet functional.]{.mark}
```{r}
stockplotr::table_landings(
  dat = petrale,
  group = "fleet",
  unit_label = "mt",
  make_rda = TRUE, # new argument needed to export plot
  tables_dir = getwd() # indicate where to create a "tables" folder with the landings table rda
)
```

Import the sample table rda and explore it:

```{r}
load("example_plots/ex_table.rda")
rda$table
rda$caption
```

::: {.callout-important}
We are working on finishing the exporting capability of `table_landings()`. When it's functional, the landings table will be exported using the `make_rda` and `tables_dir` arguments, in parallel to `plot_spawning_biomass()` shown above.
:::

::: {.callout-tip}
We have designed two functions that allow you to automatically create all available figures and tables:

- `save_all_plots()`
- `html_all_figs_tables()`
:::

::: {.callout-note appearance="minimal"}
20 minute break for questions & practicing
:::

{{< include ../snippets/figure_table_exercises.qmd >}}

# Integrating {stockplotr} into the workflow

For the second half of today's lesson, let's reorient ourselves. We've just learned how to make figures and tables with {stockplotr}. Now, we'll cover how to add those plots into your {asar} report template.

Remember that after running the primary {asar} function-- `create_template()`- you have a 'report' folder with several files in it. These files include the report skeleton; the child documents containing the executive summary, introduction, results, and so on; and, importantly for us right now, the documents that will contain code to display your figures and tables. The files will be named something like '08_tables.qmd' and '09_figures.qmd' (the prefix numbers may vary).

Each file will contain zero figures or tables. Instead, they will contain a statement referring you to {stockplotr} so that you can make your own. Since we've created those already, let's add them to your report!

## Adding tables and figures to your report

You can add your figures and tables with two workflows:

1. Running `asar::create_tables_doc()` and `asar::create_figures_doc()`
  - If you fill in arguments that allow R to find your tables and figures, then it will place them into the respective tables and figures docs automatically.
2. Adding your tables and figures manually to each doc.

### Option 1: Running `asar::create_tables_doc()`/`asar::create_figures_doc()`

*This is also known as the [rda-based workflow](https://nmfs-ost.github.io/asar/articles/custom-figs-tabs.html#comparing-workflows)*.

#### Figures

To add figures, first ensure that your folder containing the figures is called "figures".

Then, there are only two arguments to fill out:

1. `subdir`: The location where the *new* figures doc should be saved (we recommend your 'report' folder, so it overwrites the old, empty version)
2. `figures_dir`: The location of your "figures" folder

```{r}
#| label: add-figures
#| eval: false
#| warning: false
#| messages: false
create_figures_doc(
  subdir = fs::path(getwd(), "report"), # indicates the new figures doc will be saved in your "report" folder, located in the working directory
  figures_dir = getwd() # indicates your "figures" folder is located in the working directory
                  )
```

Now, open your new figures doc and take a look!

You'll notice the following structure:

**Chunk 1** will always create an object saving the location of your `figures_dir`.

Then, there will be at least two chunks for each figure. For each figure,

**Chunk 2** will:

* load an rda containing a figure
* give the rda a specific name
* save the figure, caption, and alternative text as separate objects

**Chunk 3** will:

* display the figure

#### Tables {#sec-rda-based-tab}

Adding tables entails nearly the same process as described for figures. The only differences are:

1. Tables will involve captions only, whereas figure require captions and alternative text
2. Tables can be rotated or split across pages.

This is the code you *would* run to add tables to the {asar} tables doc, but [it is not yet functional.]{.mark}
```{r}
#| label: add-tables
#| eval: false
#| warning: false
#| messages: false
create_tables_doc(
  subdir = fs::path(getwd(), "report"),
  tables_dir = getwd()
  )
```

::: {.callout-important}
*Once we complete redevelopment of our pilot table (`table_landings()`)*, our workflow will be able to accommodate tables that are wide enough to require rotation into a landscape-view page OR splitting across pages. For more information, please see the ["Adding Custom Figures & Tables" vignette](https://nmfs-ost.github.io/asar/articles/custom-figs-tabs.html#sec-id_width).
:::

::: {.callout-note appearance="minimal"}
Break for questions
:::

### Option 2: Manually adding tables/figures

#### Tables

You can add a regularly-sized^[Again, for tables that require rotating or splitting across pages, please refer to the ["Adding Custom Tables & Figures" vignette](https://nmfs-ost.github.io/asar/articles/custom-figs-tabs.html#sec-id_width).] table/figure manually by following these main steps:

1. Create a code chunk
2. Add your label and other chunk options
3. Add code
4. Write caption
5. Add a page break between tables (optional but recommended)

##### Direct coding-in-qmd table workflow 

Example similar to that in the ["Adding Custom Tables & Figures" vignette](https://nmfs-ost.github.io/asar/articles/custom-figs-tabs.html#direct-coding-in-qmd-workflow-option-3-2):

````{verbatim}
```{r} 
#| label: 'tbl-custom1-setup' # choose a label
#| echo: false # don't show this chunk

# Import your data
load(fs::path("petrale_conout.rda"))
petrale <- out_new

# Make your table
your_table <- head(petrale) |>
  dplyr::select(label, year, estimate) |>
  gt::gt()

```
````

````{verbatim}
```{r}
#| label: 'tbl-custom1-display' # choose a label
#| echo: false # don't show the code- only the output (table)
#| tbl-pos: 'h!' # display the table after "Tables" header
#| tbl-cap: This is your table caption.

# Show your table
your_table
```
````

![](images/petrale_table.png){fig-alt="Example of a table produced with the 'Direct coding-in-qmd table workflow' option for adding tables to asar reports."}

Then, add a pagebreak:

```{r} 
#| label: 'pgbreak'
#| eval: false
#| echo: true

{{< pagebreak >}}

``` 

::: {.callout-warning}
It will be important to add your captions and labels into a csv file when making your documents accessible. You will soon learn more about this in the the ["Adding accessibility features" section](#sec-a11y)!
:::


##### Direct image-based table insertion workflow

We don't recommended adding tables as images, since it significantly reduces the accessibility of your table. However, we understand that sometimes this is the only format available.

Use the following notation to reference an external table as an image:

`![Caption for my example table](example_table.png){fig-alt="This is the alternative text for my table", #tbl-example}`

::: {.callout-note}
Notice how there is alternative text added to this method of adding a table. In this scenario, the table is recognized as an image and thus would NOT pass accessibility checks. **Please make sure you add alternative text for image-based tables added in this way.**
:::

#### Figures

##### Direct coding-in-qmd figure workflow {#sec-code-in-qmd-fig}

Like with tables, running `create_figures_doc()` produces a blank figures Quarto file. We add figures similarly to tables. In fact, the only major difference is that you must write **alternative text** for your figure.

Put your alternative text in a chunk option called 'fig-alt' (example below).

````{verbatim}
```{r} 
#| label: 'fig-custom1-setup' # choose a label
#| echo: false

# Import your data
load(fs::path("petrale_conout.rda"))

petrale <- out_new |>
                    dplyr::filter(year > 1980) |>
                    dplyr::filter(module_name == "TIME_SERIES") |>
                    dplyr::filter(label == "biomass") |>
                    dplyr::filter(!is.na(fleet))

# Make your figure
your_figure <- ggplot2::ggplot(petrale,
  ggplot2::aes(x = year, y = estimate, color = fleet)) +
  ggplot2::geom_line(linewidth = 0.75) +
  ggplot2::geom_point() +
  ggplot2::theme_classic()
```
````

````{verbatim}
```{r}
#| label: 'fig-custom1-display' # choose a label
#| fig-cap: This is your figure caption.
#| fig-alt: This is your figure alternative text.
#| echo: false
# Show your figure
your_figure
``` 
````

![](images/petrale_figure.png){fig-alt="Example of a figure produced with the 'Direct coding-in-qmd figure workflow' option for adding figures to asar reports."}

::: {.callout-warning}
Even though you wrote alt text in the `fig-alt` area, **when you first render your report into a PDF, your alternative text will not show up in your document.** Strange, right?! **To ensure it shows up, refer to the ["Adding accessibility features" section](#sec-a11y)** (which we'll discuss in a moment).
:::

##### Direct image-based figure insertion workflow {#sec-image-based-fig}

Like tables, you can reference figures not made directly in code chunks. However, in this case, this does *not* change the accessibility of the figure because you can still add the necessary components to meet Section 508 compliance standards: alternative text and a caption.

`![Caption for my example figure](example_figure.png){fig-alt="This is the alternative text for my figure" #fig-example}`

## Referencing your tables or figures in text

Quarto uses a special notation to allow users to link tables and figures throughout their text. Use the following notation to link/reference tables in your text:

````{verbatim}
@tbl-example
````
or
````{verbatim}
@fig-example
````

Adding an `@` symbol followed by the chunk label, or label of your table/figure, will create an interactive link that lets the reader navigate to that specific table/figure.

::: {.callout-note icon=false}
## Testing your understanding

Which of the following describes how you can integrate {asar} and {stockplotr} into your reporting workflow?

A) Generating 13+ assessment figures and tables in one go using a single function (`stockplotr::save_all_plots()`).
B) Creating one specific figure (e.g., spawning biomass, using `stockplotr::plot_spawning_biomass()`).
C) Building an {asar} report template with a model results file, which allows for automatic extraction of B/BMSY and other key quantities from the model output.
D) Using {asar} to build a report template, without a converted model results file.
E) Using the entire workflow to convert model results into a standardized format, generate all plots, and integrate them into an accessible report.
F) All of the above.

:::

<!-- Answer: F. -->

::: {.callout-note appearance="minimal"}
Break for questions
:::

# Render your first report draft!

Open your skeleton qmd file, then render the report.

You can render a report in three ways:

## In the R console

Run `quarto::quarto_render([path/to/your/skeleton.qmd file])` in the console. For example:

```{r eval=FALSE}
quarto::quarto_render(
  file.path("report",
             "SAR_USWC_Petrale_sole_skeleton.qmd") # add your skeleton filename
)
```

## With the RStudio "render" button

Open the skeleton.qmd file. Then, in the program pane, press the "render" button:

![](images/render_button.png){fig-alt="Screenshot of the RStudio console with a red rectangle highlighting the location of the 'Render' button."}

## In the terminal

Run `quarto render [path/to/your/skeleton.qmd file]` in the terminal. For example:

Enter `quarto render report/SAR_USWC_Petrale_sole_skeleton.qmd`

::: {.callout-note appearance="minimal"}
20 minute break for questions & practicing
:::

{{< include ../snippets/integrate-stockplotr_exercises.qmd >}}

# Adding accessibility features {#sec-a11y}

::: {.callout-tip}
## Congrats! You're almost there!
You've made major progress towards completing your first report!
:::

While your rendered report looks superb, it's probably missing two major components: **tags and alternative text**.

If you made an HTML-based report, these features would most likely be in your document. But since we're prioritizing PDFs, there are a few more steps to take before your document will significantly more accessible than it is now. This means that, **to achieve compliance with Section 508 criteria, you must complete a couple more tasks**.

## Add tagging

In your 'report' folder, you'll find a new file with a .tex filetype: 'SAR_USWC_Petrale_sole_skeleton.tex' (or something similar). This file is a LaTex-based version of your rendered skeleton qmd file. It's also where we add our remaining accessibility features, since Quarto does not yet offer that functionality within its qmd files.

[**Tags**](https://www.section508.gov/create/pdfs/common-tags-and-usage/) are structural elements of PDFs. They are signals telling software which information are headers, images, tables, text, and so on. Tags allow people using technology like screen readers to logically navigate PDFs.

We'll use the `asar::add_tagging()` function to add tags.

```{r eval = FALSE}
asar::add_tagging(
  x = "SAR_USWC_Petrale_sole_skeleton.tex", # your .tex report file
  dir = "report", # the folder containing the .tex file
  compile = FALSE # whether the .tex file should be compiled after tagging. We'll set it to FALSE for now
  )
```

Now your PDF is tagged! If you compiled your .tex file, it'd look something like this. The tags are on the right side of the PDF viewer.

![](images/tagged_pdf.png){fig-alt="Screenshot of an example PDF-based, tagged report. The PDF is opened in Adobe and tags for the Table of Contents are shown on the right side of the screen."}

::: {.callout-warning}
## Default alt text should be updated 
If you stop here (i.e., you don't add your own alt text), this function will add the image paths as alt text. We'll show you how to add your *intended* alt text in [the next step](@sec-add-alttext).
:::

::: {.callout-note appearance="minimal"}
Break for questions
:::

## Add alternative text {#sec-add-alttext}

You must add alternative text ("alt text") for images in a separate csv if you added figures using any of the workflows described above.

Since you've used {stockplotr} to make some figures, you've already completed the first step: making a csv that will contain your alt text.

### Look at your alt text csv

The file, "captions_alt_text.csv", should be located in your working directory (enter `getwd()` if you forget where that is). Open it up.

The file is set up like this:

-   Column 1 ("label") is a shorthand label for your figure or table. Labels should be somewhat short and exclude spaces. Examples include "kobe", "relative.biomass", and "fishing.mortality".
-   Column 2 ("type") contains "figure" or "table".
-   Column 3 ("caption") contains your caption.
-   Column 4 ("alt_text") contains alternative text for figures. For tables, this column will be blank.

+-------------+------------+-----------------------------+--------------------------------------+
| label       | type       | caption                     | alt_text                             |
+=============+============+=============================+======================================+
| example_fig | figure     | Example caption for figure. | Example alternative text for figure. |
+-------------+------------+-----------------------------+--------------------------------------+
| example_tab | table      | Example caption for table.  |                                      |
+-------------+------------+-----------------------------+--------------------------------------+

: Format for csv containing table and figure captions and alternative text.

### Update the csv

Your job is to:

* *edit* existing entries for your figures already created with {stockplotr}. This entails [checking the accuracy, and writing the final component, of the existing alt text](https://nmfs-ost.github.io/asar/articles/accessibility_guide.html#your-to-do-list).
* *add* entries for your custom figures.

#### Editing existing entries {#sec-edit-exist-entries}

Using the "label" column, find the row associated with your figure and inspect it.

* You'll see that there's already some prewritten alt text (in the "alt_text" column) that includes data from the model results file. Now, **you must check this information for accuracy and update it where necessary** (especially if the default figures were modified).

* If you see text that looks like a placeholder (e.g., "The x axis, showing the year, spans from B.start.year to B.end.year..."), that means that there was at least one instance where our tool failed to extract a specific value from the model results, calculate a key quantity (like the start year of a biomass plot- aka "B.start.year"), and substitute it into the placeholder.

::: {.callout-important}
While we have extracted key quantities as accurately as possible, we cannot guarantee that each quantity will have been calculated perfectly. Input data varies widely. **It's your responsibility to check the accuracy of your figures' alt text.**
:::

* This prewritten alt text usually contains 3/4 essential ingredients for well-written alt text. The remaining ingredient (#4): the relationship between the variables shown (i.e., what the figure is conveying). Since we can't program {stockplotr} to analyze the figure's meaning, **you must provide this crucial component**.

When you're satisfied, save the csv.

#### Adding new entries

* Make a new row.
* For "label", take the "label" of your figure chunk.
  * For figures [coded in chunks](#sec-code-in-qmd-fig), our example label would be "fig-custom1".
  * For figures [added with markdown](#sec-image-based-fig)^[`![Caption for my example figure](example_figure.png){fig-alt="This is the alternative text for my figure", #fig-example}`] (i.e., premade pngs or jpgs), our example label would be "fig-example".
* The type will be "figure".
* The caption should be identical to the caption in your chunk (what you put in "fig-cap").
* The "alt_text" will contain your alt text. See the "[Editing existing entries](#sec-edit-exist-entries)" section above, and the "[Achieve Greater Accessibility](https://nmfs-ost.github.io/asar/articles/accessibility_guide.html)" vignette, for help writing alt text.

When you're satisfied, save the csv.

## Add alt text to your report's images

Now, we'll use the `asar::add_alttext()` function to add the alt text into the report's .tex file.

```{r eval = FALSE}
add_alttext(
    x = "SAR_USWC_Petrale_sole_skeleton.tex", # your .tex report file
    dir = "report", # the folder containing the .tex file
    alttext_csv = "captions_alt_text.csv", # the filename of your csv with captions and alt text, located in the working directory
    compile = TRUE # now we'll compile the PDF
  )
```

Now your PDF's figures have alt text! You can find and edit the alt text by following these steps:

![1. Open the 'All Tools' menu in Adobe. Scroll down until you reach the "Prepare for accessibility" button. Click it.](images/Check_alttext-1.png){fig-alt="Screenshot of a document opened in Adobe. The 'All Tools' menu shows a red oval around the 'Prepare for accessibility' button."}

![2. In the 'Prepare for accessibility', click the "Add alternate text" button.](images/Check_alttext-2.png){fig-alt="Screenshot of a document opened in Adobe. The 'Prepare for accessibility' menu shows a red oval around the 'Add alternate text' button."}

![3. In the 'Set alternate text' pop-up, verify that your images contain the expected alternative text and edit as necessary.](images/Check_alttext-3.png){fig-alt="Screenshot of a document opened in Adobe. The 'Set alternate text' pop-up shows where an example image's alternative text is located."}

::: {.callout-tip}
The function [`asar::add_accessibility()`](https://github.com/nmfs-ost/asar/blob/main/R/add_accessibility.R) performs the same tasks as `asar::add_tagging()` + `asar::add_alttext()` combined! Here, we showed the latter functions to explain how they work, but you can use `asar::add_accessibility()` once you're comfortable with these steps.
:::

::: {.callout-note icon=false}
## Testing your understanding

You need to update the alt text for your biomass figure because your interpretation of the plot has changed. Where should you edit this plot's alt text?

A) In the code chunk in the 09_figures.qmd file
B) In the alt_text_captions.csv file
C) In the YAML at the top of the skeleton .qmd file
D) By right-clicking the figure in the RStudio "plots" pane

:::

<!-- Answer: B. -->
<!-- A identifies "Standard Quarto" thinking. While standard Quarto uses chunk options, {asar} uses the .csv as a single source of truth. When creating PDFs, alt text is taken from the csv-- not from the code chunk. -->
<!-- C & D do not allow any way to edit alt text. -->

::: {.callout-tip}
Check out the ["Increasing Report Accessibility" vignette](https://nmfs-ost.github.io/asar/articles/accessibility_guide.html), which contains all kinds of accessibility-related information related to alternative text, using acronyms, learning about the status of accessibility features in {asar} with relation to Section 508 standards, and more.
:::

::: {.callout-note appearance="minimal"}
20 minute break for questions & practicing
:::

{{< include ../snippets/a11y_exercises.qmd >}}

# Questions, comments, feedback, and closing

::: {.callout-tip}
Your colleagues have created some terrific stock assessment reports with {asar}. Check them out on our ["Example Reports" page](https://nmfs-ost.github.io/asar/articles/example_reports.html)!
:::

Please navigate to the [Feedback](https://docs.google.com/document/d/1SY-xwHXnJUXSXTTeaPA_UkmXXVmUK9Ol751nh6Vtjmg/edit?tab=t.vffehz79fm7y#heading=h.llbcc8tygqlb) heading and tell us what you thought about today's workshop. Only 3 simple questions!

* What went well?
* What could be improved?
* What is a question you still have?
